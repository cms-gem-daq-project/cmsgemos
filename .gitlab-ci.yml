## GitLab Continuous Integration YAML file for cmsgemos

## ------------------- used variables: ------------------- ##
  # https://gitlab.cern.ch/help/ci/variables/README.md
  # CI_COMMIT_TAG
  # CI_COMMIT_REF_NAME
  # CI_COMMIT_SHA
  # CI_MERGE_REQUEST_TARGET_BRANCH_NAME
  # CI_MERGE_REQUEST_TARGET_BRANCH_SHA
  # GITLAB_USER_EMAIL
  # GITLAB_USER_ID
  # GITLAB_USER_LOGIN
  # GITLAB_USER_NAME

## ------------------- used secure variables: ------------------- ##
  # EOS_ACCOUNT_USERNAME: Username of  to write in the EOS folder whose path is EOS_PATH
  # EOS_ACCOUNT_PASSWORD: Account password
  # KRB_PASSWORD
  # KRB_USERNAME
  # CI_DEPLOY_USER
  # CI_DEPLOY_PASSWORD

## ------------------- Stage definitions ------------------- ##
stages:
  - compile  # compile the sources, make the docs (if requested)
  # - docs     # compile the docs (if requested)
  - test     # test the packages (make install, run basic tests)
  - package  # build the RPMs
  - publish  # publish the RPMs and docs

## ------------------- Define up anchors for various tasks, shared across all jobs utilizing them ------------------- ##
.common_variables: &common_variables
  EOS_SITE_URL:           http://cmsgemdaq.cern.ch
  BUILD_HOME:             /builds/${CI_PROJECT_NAMESPACE}
  XDAQ_OS:                linux
  XDAQ_ROOT:              /opt/xdaq
  LD_LIBRARY_PATH:        /opt/xdaq/lib
  PACKAGE_NAME:           ${CI_PROJECT_NAME}
  ARTIFACTS_DIR:          artifacts
  GIT_SUBMODULE_STRATEGY: normal
  # REPO_NAME:         ${${CI_REPOSITORY_URL##?*/}%%.*}

variables: *common_variables

## ------------------- Set up images for specified job types ------------------- #
.cc7setup: &cc7setup
  image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc7
  # image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc7:xdaq14-6
  # image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc7:xdaq15

.cc8setup: &cc8setup
  image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc8
  # image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc8:python2
  # image: gitlab-registry.cern.ch/cms-gem-daq-project/gemdaq_ci_worker/extrapy/devtoolsroot:cc8:python3

### ------------------- Shared setup between stages ------------------- ###
.common_setup: &common_setup
  - mkdir -p ${ARTIFACTS_DIR}
  ## need to pull in all cmsgemos dependencies, based on some requirements, preferably the spec file?
  ## cache this stuff between builds?
  ## should be in the Docker image
  - |
    pip install -I --user "pip" "importlib" "codecov" "setuptools<38.2"
    sudo yum install -y xhal\* --enablerepo=gemos*
    # sudo yum install -y wiscrpcsvc\* --enablerepo=gemos*
    # sudo yum install -y reedmuller\* --enablerepo=gemos*
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/etc/profile.d/gemdaqenv.sh
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/paths.sh

.retry_settings: &retry_settings
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      
.common_cache: &common_cache
  # key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
  # key: "$BUILD_ARCH"
  untracked: true
  paths:
    - ~/.cache/pip
    # - /opt/ctp7_modules
    # - /opt/reedmuller
    # - /opt/reg_utils
    # - /opt/rwreg
    # - /opt/wiscrpcsvc
    # - /opt/xhal
  
.common_artifacts: &common_artifacts
  name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
  expire_in: 1d
  paths:
    - ${ARTIFACTS_DIR}
  
##### ------------------- Run compilation ------------------- #####
.compile_artifacts: &compile_artifacts
  ## take all compile artifacts and save
  untracked: true
  <<: *common_artifacts
  # paths:
  #   - ${ARTIFACTS_DIR}
  #   - gem*/src/**/*.d
  #   - gem*/src/**/*.o
  #   - gem*/lib/**/*.so
  #   - gempython/pkg

.before_compile: &before_compile
  - mkdir -p ${ARTIFACTS_DIR}
  ## need to pull in all cmsgemos dependencies, based on some requirements, preferably the spec file?
  ## cache this stuff between builds?
  - |
    sudo yum install -y xhal\* --enablerepo=gemos*
    # sudo yum install -y wiscrpcsvc\* --enablerepo=gemos*
    # sudo yum install -y reedmuller\* --enablerepo=gemos*
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/etc/profile.d/gemdaqenv.sh
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/paths.sh

.compile_common: &compile_common
  only:
    - /^issue.*$/
    - /^issue-.*$/
    - /^.*.hotfix.*$/
    - /^release.*$/
    - /^feature.*$/
    - /^feature.*ci-cd*$/
    - /^citest.*$/
    - develop
    - master
    - tags
  tags:
  stage: compile
  before_script:
    *before_compile
  script:
    # - | ## each line is a new line
    # - > ## each line is part of the previous line, no newline
    #   if [ -n "${DEVTOOLGCC}" ];
    #   then
    #     echo "Enabling ${DEVTOOLGCC}";
    #     . /opt/rh/${DEVTOOLGCC}/enable;
    #   fi
    - |
      touch gempython/CHANGELOG.md
      touch gempython/LICENSE
      touch gempython/__init__.py
    - make all -j8
  after_script:
    - ls -la ${ARTIFACTS_DIR}
  artifacts:
    <<: *compile_artifacts

compile:cc7:
  <<: *cc7setup
  <<: *compile_common
  environment:
  variables:

# compile:cc7:devtools8:
#   <<: *cc7setup
#   <<: *compile_common
#   environment:
#   variables:
#     DEVTOOLGCC:     devtoolset-8

# compile:cc8:
#   <<: *cc8setup
#   <<: *compile_common
#   environment:
#   variables:
#   cache:
    
# coverage:
#   coverage: '/Code coverage: \d+\.\d+/'

##### ------------------- Generate docs ------------------- #####
.docs_artifacts: &docs_artifacts
  ## take all docs artifacts and save
  <<: *common_artifacts
  # paths:
  #   - ${ARTIFACTS_DIR}
  #   - doc/build/html

docs:
  <<: *cc7setup
  stage: compile
  only:
    - /^feature.*ci-cd*$/
    - /^citest.*$/
    - /^develop$/
    - /^release.*$/
    - tags
    - master
  dependencies:
  before_script:
    - eval `set | egrep '^(CI|GIT)' | awk -F= '{ print "export " $1 }'`
    - eval `set | egrep '^(BUILD|REL|PACK|ARTI|XDAQ|CMS|LD)' | awk -F= '{ print "export " $1 }'`
    - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/etc/profile.d/gemdaqenv.sh
    - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/paths.sh
  script:
    - make doc
  after_script:
    - |
      mkdir -p ${ARTIFACTS_DIR}/api
      mv -t ${ARTIFACTS_DIR}/api/ doc/build/html/*
  artifacts:
    name: ${CI_JOB_STAGE}
    <<: *docs_artifacts
  coverage: '/Documentation coverage: \d+\.\d+/'

##### ------------------- Run tests using the compiled binaries ------------------- #####
.before_test: &before_test
  - eval `set | egrep '^(CI|GIT)' | awk -F= '{ print "export " $1 }'`
  - eval `set | egrep '^(BUILD|REL|PACK|ARTI|XDAQ|CMS|LD)' | awk -F= '{ print "export " $1 }'`
  - |
    sudo yum install -y xhal\* --enablerepo=gemos*
    # sudo yum install -y wiscrpcsvc\* --enablerepo=gemos*
    # sudo yum install -y reedmuller\* --enablerepo=gemos*
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/etc/profile.d/gemdaqenv.sh
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/paths.sh
  
test:cc7:
  <<: *cc7setup
  stage: test
  dependencies:
    - compile:cc7
    # - package:cc7 ## maybe don't depend on RPMs, rather use a make install target?
  before_script:
    *before_test
  script:
    - echo "FIXME: ${BUILD_HOME}/runmytests.sh"
    - echo "FIXME: export INSTALL_PREFIX=${BUILD_HOME}/local"
    - echo "FIXME: make install"
    - echo "FIXME: make tests-ci"
    - echo "FIXME: make run-tests-ci"
    - echo "FIXME: make check-abi"
  after_script:
    - echo "FIXME: parse-abi-changes.sh"
    - echo "FIXME: test summary"
  coverage: '/Test coverage: \d+\.\d+/'

##### ------------------- Package generated files into RPMs and tarballs ------------------- #####
.rpm_artifacts: &rpm_artifacts
  ## take all packaging artifacts and save
  <<: *common_artifacts
  # paths:
  #   - ${ARTIFACTS_DIR}
  #   - gem*/rpm/**/*.rpm
  #   - gem*/rpm/**/*.tar.gz
  #   - gem*/rpm/**/*.tbz2
  #   - gem*/rpm/**/*.zip
  #   - gem*/rpm/**/*.tgz
  
.before_package: &before_package
  - mkdir -p ${ARTIFACTS_DIR}
  - |
    pip install -I --user "pip" "importlib" "codecov" "setuptools<38.2"
    sudo yum install -y xhal\* --enablerepo=gemos* ## FIXME should be unnecessary if make targets work properly?
    # sudo yum install -y wiscrpcsvc\* --enablerepo=gemos*
    # sudo yum install -y reedmuller\* --enablerepo=gemos*
  ## need to pull in all cmsgemos dependencies, based on some requirements, preferably the spec file?
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/etc/profile.d/gemdaqenv.sh
  - . ${BUILD_HOME}/${CI_PROJECT_NAME}/setup/paths.sh

.package_common: &package_common
  stage: package
  before_script:
    *before_package
  script:
    ## Ensure compile artifacts are more recent than the checkout
    - |
      find ./gem* -type f \( -name '*Gen.h' -o -name '*Gen.cc' \) -print0 -exec touch {} \;
      find ./gem* -type f -name '*.d' -print0 -exec touch {} \;
      find ./gem* -type f -name '*.o' -print0 -exec touch {} \;
      find ./gem* -type f -name '*.so' -print0 -exec touch {} \;
    ## FIXME hack until these are properly handled
    - |
      touch gempython/CHANGELOG.md
      touch gempython/LICENSE
      touch gempython/__init__.py
    - make rpm
    ## Move packaged files to deployment staging area
    - eval `set | egrep '^(CI|GIT)' | awk -F= '{ print "export " $1 }'`
    - eval `set | egrep '^(EOS|BUILD|REL|PACK|ARTI|XDAQ|CMS|LD)' | awk -F= '{ print "export " $1 }'`
    - .ci/generate_repo.sh
  after_script:
    - ls -la ${ARTIFACTS_DIR}
    - ls -la ${ARTIFACTS_DIR}/repos
  artifacts:
    <<: *rpm_artifacts
  
package:cc7:unstable:
  <<: *cc7setup
  only:
    - /^develop$/
    - /^feature.*ci-cd*$/
    - /^citest.*$/
    # - triggers            ## should go into releases/'testing' or unstable?
    # - chat                ## should go into releases/'testing' or unstable?
    # - api                 ## should go into releases/'testing' or unstable?
  tags:
  variables:
    COMPILER: 'gcc'
    PYEXE: 'python2.7'
    PACKAGE_TYPE: 'unstable'
  dependencies:
    - compile:cc7
    - docs
  <<: *package_common

package:cc7:testing:
  <<: *cc7setup
  only:
    - /^release.*$/
  tags:
  variables:
    COMPILER: 'gcc'
    PYEXE: 'python2.7'
    PACKAGE_TYPE: 'testing'
  dependencies:
    - compile:cc7
    - docs
  <<: *package_common

package:cc7:base:
  <<: *cc7setup
  only:
    - tags
  tags:
  variables:
    COMPILER: 'gcc'
    PYEXE: 'python2.7'
    PACKAGE_TYPE: 'base'
  dependencies:
    - compile:cc7
    - docs
  <<: *package_common

##### ------------------- Publish RPMs, docs, and tarballs ------------------- #####
.publish_variables: &publish_variables
  EOS_BASE_WEB_DIR:   "/eos/project/c/cmsgemdaq/www"
  EOS_COMMON_WEB_DIR: "cmsgemdaq"
  EOS_DOC_NAME:       "api"
  EOS_REPO_NAME:      "repos"
  EOS_SITE_WEB_DIR:   "${EOS_BASE_WEB_DIR}/${CI_PROJECT_NAME}"
  EOS_SW_DIR:         "${EOS_BASE_WEB_DIR}/sw/${CI_PROJECT_NAME}"
  EOS_DOCS_DIR:       "${EOS_BASE_WEB_DIR}/docs/${CI_PROJECT_NAME}"
  EOS_UNSTABLE_DIR:   "${EOS_BASE_WEB_DIR}/sw/${CI_PROJECT_NAME}/unstable"
  EOS_RELEASE_DIR:    "${EOS_BASE_WEB_DIR}/sw/${CI_PROJECT_NAME}/releases"
  
.publish_common: &publish_common
  <<: *cc7setup
  stage: publish
  variables: *publish_variables
  before_script:
    - eval `set | egrep '^(KRB|CI|GIT)' | awk -F= '{ print "export " $1 }'`
    - eval `set | egrep '^(EOS|BUILD|REL|PACK|ARTI|XDAQ|CMS|LD)' | awk -F= '{ print "export " $1 }'`
  script:
    # - push python packages to pypi/conda
    # - push RPMs to packagecloud.io
    # - push RPMs to gitlab yum repo, a la xDAQ?
    # - push sphinx/rst/md/rtd docs to readthedocs.io
    # - push sphinx/rst/md/rtd docs to $EOS_WEB_DIR/docs/${fulltag}, update doc main page index
    - echo "FIXME: github_changelog_generator"
    - echo "FIXME: cp CHANGELOG.md ${ARTIFACTS_DIR}"
    - .ci/publish_eos.sh
    - if [ -n "${DEBUG_CI}" ]; then sleep 500; fi
    

# publish:debug:
#   variables:
#     EOS_BASE_WEB_DIR: /tmp/
#   <<: *publish_common
#   variables:
#     DEBUG_CI: 'yes'
#   only:
#     - /^citest.*$/
#   when: manual
#   after_script:

publish:unstable:
  variables:
    EOS_BASE_WEB_DIR: /tmp/
  <<: *publish_common
  only:
    - /^feature.*ci-cd*$/
    - /^citest.*$/
    - /^develop$/
  dependencies:
    - package:cc7:unstable
  after_script:
    - ls -la ${ARTIFACTS_DIR}

publish:testing:
  <<: *publish_common
  only:
    - /^release.*$/
  dependencies:
    - package:cc7:testing
  after_script:
    # - notify mattermost
    # - send email
    # - generate_release.sh pre

publish:base:
  <<: *publish_common
  only:
    - tags
  dependencies:
    - package:cc7:base
  after_script:
    - echo "FIXME: github_changelog_generator"
    - echo "FIXME: generate_release_notes.sh"
    # - notify mattermost
    # - send email
    # - generate_release.sh rel
